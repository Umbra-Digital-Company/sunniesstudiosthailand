{% liquid
  assign list_id = settings.newsletter_subs_popup_list_id
  assign heading = settings.newsletter_subs_popup_heading
  assign success_message = settings.newsletter_subs_popup_success_message
%}

<div class="newsletter-subs-container">
  <img class="newsletter-subs__image"
    style="--image-desktop: url('{{ section.settings.bg_image_desktop | image_url }}'); --image-mobile:  url('{{ section.settings.bg_image_mobile | image_url }}')"
    alt="Newsletter Subscription" />
  <div class="newsletter-subs__form">
    <form id="email_signup" class="klaviyo_styling klaviyo_gdpr_embed_LIST_ID"
      action="//manage.kmail-lists.com/subscriptions/subscribe"
      data-ajax-submit="//manage.kmail-lists.com/ajax/subscriptions/subscribe" method="POST"
      novalidate="novalidate">
      <input type="hidden" name="g" value="{{ section.settings.list_id }}">
      <input type="hidden" name="$fields" value="Birthday,Shopping_For">
      <input type="hidden" name="Shopping_For" id="shopping_for_hidden" value="">
      <h1 class="hide_on_submit">{{ section.settings.heading }}</h1>
      <h2 class="hide_on_submit">{{ section.settings.subheading }}</h2>
      <div class="klaviyo_field_group klaviyo_form_actions">
        <input class="" type="email" value="" name="email" id="email" placeholder="Email address" />
        <input class="" type="hidden" value="" name="Birthday" id="birthday" />
        <div class="birthday-input">
          <div class="birthday-input__display">Birthday</div>
          <div class="birthday-input__fields">
            <div class="birthday-input__input-container">
              <input id="birthdayMonth" type="number" value="" min="1" max="12" placeholder="MM" maxlength="2" />
            </div>
            <span>/</span>
            <div class="birthday-input__input-container">
              <input id="birthdayDay" type="number" value="" min="1" max="31" placeholder="DD" maxlength="2" />
            </div>
            <span>/</span>
            <div class="birthday-input__input-container">
              <input id="birthdayYear" type="number" value="" min="1000" placeholder="YYYY" maxlength="4" />
            </div>
          </div>
        </div>
        <div class="shopping-for__input-container">
          <h3>Shopping for:</h3>
          <div class="shopping-preference">
            <div>
              <input type="radio" id="eyewear" name="shopping_for" value="Eyewear">
              <label for="eyewear">Eyewear</label>
            </div>
            <div>
              <input type="radio" id="flask" name="shopping_for" value="Flask">
              <label for="flask">Flask</label>
            </div>
            <div>
              <input type="radio" id="both" name="shopping_for" value="Both">
              <label for="both">Both</label>
            </div>
          </div>
        </div>
      </div>
      <div class="klaviyo_messages">
        <div class="success_message" style="display:none;">
          <h1>{{ section.settings.success_message_heading }}</h1>
          <h2>{{ section.settings.success_message_subheading }}</h2>
          <a class="newsletter-subs__btn" href="{{ section.settings.success_message_btn_link }}">{{
            section.settings.success_message_btn_text }}</a>
        </div>
        <div class="error_message" style="display:none;"></div>
      </div>
      <div class="klaviyo_submit">
        <button type="submit" class="klaviyo_submit_button">Subscribe</button>
        <button type="button" id="submitBtnCustom" class="klaviyo_form_actions newsletter-subs__btn">Subscribe</button>
      </div>
    </form>
  </div>
</div>

<style>
  .newsletter-subs-container {
    position: relative;
    color: var(--black_color);
  }

  .newsletter-subs__image {
    content: var(--image-mobile);
    object-fit: cover;
    height: 296px;
    width: 100%;
  }

  .newsletter-subs__form {
    padding: 60px 40px;
    width: 100%;
  }

  .newsletter-subs__form h1 {
    font-family: 'AT Surt Medium';
    font-size: 28px;
    text-align: center;
    margin: 0;
  }

  .newsletter-subs__form h2 {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    text-align: center;
    margin-top: 16px;
  }

  .klaviyo_styling {
    max-width: unset;
    margin-bottom: 0;
  }

  .klaviyo_styling .klaviyo_form_actions {
    text-align: left;
  }

  .klaviyo_styling .klaviyo_submit_button {
    display: none;
  }

  .klaviyo_styling .klaviyo_field_group {
    margin-top: 40px;
    margin-bottom: 0;
  }

  .klaviyo_field_group input {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    margin: 0;
    width: 44px;
    color: var(--black_color);
  }

  .klaviyo_field_group label[for="email"] {
    display: none;
  }

  input#birthdayMonth, input#birthdayDay {
    max-width: 32px !important;
  }

  .klaviyo_field_group input[name="email"], .klaviyo_field_group .birthday-input {
    border: 1px solid #f8f8f8;
    padding: 4px 0;
    border-radius: 8px;
    /* border-bottom: 1.5px solid var(--black_color); */
    text-transform: unset;
    background: #F8F8F8;
    padding: 7px 10px;
    height: 40px;
  }

  .klaviyo_field_group input::placeholder {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    color: var(--neutral_six_color);
    text-transform: initial;
  }

  .klaviyo_field_group label[for="birthday"] {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    display: block;
    font-weight: 400;
    margin-top: 16px;
    color: var(--neutral_six_color);
  }

  .klaviyo_field_group .birthday-input {
    position: relative;
    display: flex;
    gap: 2px;
    margin-top: 8px;
    overflow: hidden;
  }

  .birthday-input__display {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    padding-left: 10px;
    font-family: 'Radio Grotesk';
    font-size: 14px;
    color: var(--neutral_six_color);
    background: #F8F8F8;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 1;
  }

  .birthday-input__fields {
    display: flex;
    width: 100%;
    gap: 2px;
    align-items: center;
    z-index: 0;
  }

  .birthday-input:hover .birthday-input__display,
  .birthday-input:focus-within .birthday-input__display,
  .birthday-input.has-value .birthday-input__display {
    opacity: 0;
  }

  .klaviyo_field_group .birthday-input .birthday-input__fields {
    display: flex;
    gap: 2px;
    justify-content: start;
    align-items: center;
  }

  .klaviyo_field_group .birthday-input .birthday-input__input-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .klaviyo_field_group .birthday-input input {
    text-align: center;
    padding: 0;
    border: 0;
  }

  .input-error-message {
    font-family: 'Radio Grotesk';
    font-size: 10px;
    color: #B44720;
    display: block;
    margin-top: 4px;
    margin-bottom: 8px;
  }

  .klaviyo_field_group .birthday-input input::placeholder {
    text-align: center;
  }

  .klaviyo_submit {
    display: flex;
    justify-content: center;
  }

  .success_message {
    text-align: center;
  }

  .success_message h1 {
    font-family: 'AT Surt Medium';
    font-size: 28px;
    text-align: center;
  }

  .success_message h2 {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    text-align: center;
  }

  .newsletter-subs__btn {
    font-family: 'AT Surt Medium';
    font-size: 14px;
    text-decoration: none;
    color: white;
    display: inline-block;
    padding: 16px 40px;
    background-color: var(--black_color);
    border-radius: 8px;
    margin-top: 40px;
    border: 1.5px solid transparent;
    width: 211px;
    justify-content: center;
    margin: 40px auto 0;
  }
  
  @media (max-width: 768px) {
    .newsletter-subs__btn {
      max-width: 195px;
    }
  }

  #birthdayYear {
    max-width: 50px !important;
    width: 50px;
  }

  .newsletter-subs__btn:hover {
    color: var(--black_color);
    border-color: var(--black_color);
    background-color: transparent;
  }

  .klaviyo_styling .klaviyo_messages .success_message {
    margin-bottom: 0;
    line-height: 150%;
  }

  .error_message {
    margin-top: 16px;
  }

  .klaviyo_field_group:has(> .input-error-message) #email {
    border: 1px solid #B44720;
  }

  .klaviyo_field_group:has(> .input-error-message) .birthday-input {
    border: 1px solid #B44720;
  }

  /* .shopping-preference:has(+ .input-error-message) {
    padding-bottom: 8px;
    border-bottom: 1px solid #B44720;
  } */

  @media only screen and (min-width: 769px) {
    .newsletter-subs__image {
      content: var(--image-desktop);
      height: 800px;
    }

    .newsletter-subs__form {
      position: absolute;
      bottom: 71px;
      right: 90px;
      background-color: white;
      padding: 80px 60px;
      max-width: 450px;
      border-radius: 8px;
    }

    .newsletter-subs__form {
      padding: 64px 40px;
    }

    .newsletter-subs__form h1 {
      font-size: 32px;
    }

    .newsletter-subs__form h2 {
      font-size: 16px;
    }

    .klaviyo_styling .klaviyo_field_group {
      margin-top: 40px;
    }

    .klaviyo_field_group label[for="birthday"] {
      font-size: 16px;
      margin-top: 24px;
    }

    .klaviyo_styling input {
      font-size: 16px;
    }

    .klaviyo_styling input[type="email"] {
      font-size: 16px;
    }

    .input-error-message {
      font-size: 12px;
    }

    .klaviyo_field_group input::placeholder {
      font-size: 16px;
    }

    .newsletter-subs__btn {
      font-size: 16px;
      margin-top: 40px;
    }

    .success_message h1 {
      font-size: 32px;
    }

    .success_message h2 {
      font-size: 16px;
    }

    .birthday-input__display {
      font-size: 16px;
    }
  }

  .shopping-for__input-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    margin-top: 24px;
  }

  .shopping-for__input-container h3 {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    color: var(--soft-black-700, #352B27);
    line-height: 20px;
    margin-bottom: 8px;
  }

  .shopping-preference {
    display: flex;
    gap: 8px;
    justify-content: space-between;
    text-align: center;
    align-items: center;
  }

  .shopping-preference label {
    font-family: 'Radio Grotesk';
    margin-bottom: 0;
    font-weight: 400 !important;
  }

  .shopping-preference div {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .shopping-preference div:last-child {
    margin-right: 26px;
  }

  .shopping-preference div input[type="radio"] {
    appearance: none;
    width: 24px !important;
    height: 24px;
    border: 1px solid #D7D6D0;
    border-radius: 50%;
    cursor: pointer;
  }

  .shopping-preference div input[type="radio"]:checked {
    background-color: #FFF;
    border-style: outset;
    border: 1px solid #352B27;
    position: relative;
  }

  .shopping-preference div input[type="radio"]:checked::after {
    content: '';
    display: flex;
    width: 70%;
    height: 70%;
    border-radius: 100%;
    background: #352b27;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .shopping-preference div label {
    font-family: 'Radio Grotesk';
    font-size: 14px;
    color: var(--soft-black-600, #554D4A);
    line-height: 20px;
    margin-left: 8px;
  }

  .shopping-preference input {
    width: auto !important;
  }

  .klaviyo_styling .klaviyo_messages .success_message h2 {
    justify-content: center;
  }

  #submitBtnCustom {
    text-align: center;
  }
</style>
<script src="{{ 'validate-string-date.js' | asset_url }}" defer="defer"></script>
<script type="text/javascript" src="//www.klaviyo.com/media/js/public/klaviyo_subscribe.js"></script>
<script type="text/javascript">
  // Attach to standard form
  KlaviyoSubscribe.attachToForms('#email_signup', {
    success: function ($form) {
      $('.hide_on_submit').hide()
      $('.success_message').show();
    },
    hide_form_on_success: true,
    custom_success_message: true
  }, 3000);

  // Attach to modal form with delay
  setTimeout(() => {
    console.log("Attaching Klaviyo modal form...");
    KlaviyoSubscribe.attachToModalForm('#newsletterSubsModal', {
      delay_seconds: 0.01,
      success: function ($form) {
        console.log("Form submitted successfully.");
        document.querySelector('#newsletterSubsModal .hide_on_submit').style.display = "none";
      },
      custom_success_message: true,
      has_closed_modal_cookie_name: 'newsletterSubsModal'
    });
  }, 45000);

  const isEmail = (email) => {
    console.log(`Validating email: ${email}`);
    const regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    return regex.test(email);
  };

  const validate = (values) => {
    console.log("Validating form values:", values);
    const errors = {};

    if (!values.email) {
      errors.email = "Email address is required";
    } else if (!isEmail(values.email)) {
      errors.email = "Invalid email address";
    }

    if (!values.birthdayMonth || values.birthdayMonth < 1 || values.birthdayMonth > 12) {
      errors.birthdayMonth = "Invalid birthday";
    }

    if (!values.birthdayDay || values.birthdayDay < 1 || values.birthdayDay > 31) {
      errors.birthdayDay = "Invalid birthday";
    }

    if (!values.birthdayYear || values.birthdayYear < 1000 || values.birthdayYear > new Date().getFullYear()) {
      errors.birthdayYear = "Invalid birthday";
    }

    if (!values.shoppingFor) {
      errors.shoppingFor = "Please select an option";
    }

    console.log("Validation errors:", errors);
    return errors;
  };

  const getValues = () => {
    const values = {};
    values.email = $("input[name='email']").val();
    values.birthdayMonth = $("#birthdayMonth").val();
    values.birthdayDay = $("#birthdayDay").val();
    values.birthdayYear = $("#birthdayYear").val();
    values.shoppingFor = $("input[name='shopping_for']:checked").val();
    // console.log("Collected form values:", values);
    return values;
  };

  const renderErrors = (errors) => {
    console.log("Rendering errors:", errors);
    $('.input-error-message').remove();

    if (errors.email) {
      $(`<span class="input-error-message">${errors.email}</span>`)
        .insertAfter("input[name='email']");
      $("input[name='email']").css('border', '1px solid #B44720');
    } else {
      $("input[name='email']").css('border', '1px solid #f8f8f8');
    }

    if (errors.birthdayMonth || errors.birthdayDay || errors.birthdayYear) {
      $(`<span class="input-error-message">Please enter a valid birthday</span>`)
        .insertAfter(".birthday-input");
      $(".birthday-input").css('border', '1px solid #B44720');
      $(".birthday-input").addClass('has-value');
    } else {
      $(".birthday-input").css('border', '1px solid #f8f8f8');
    }

    if (errors.shoppingFor) {
      $(`<span class="input-error-message">${errors.shoppingFor}</span>`)
        .insertAfter(".shopping-preference");
    }
  };

  const passValuesToHiddenInputs = () => {
    const month = $("#birthdayMonth").val().padStart(2, '0');
    const day = $("#birthdayDay").val().padStart(2, '0');
    const year = $("#birthdayYear").val();
    if (month && day && year) {
      const formattedDate = `${month}/${day}/${year}`;
      $('input[name="Birthday"]').val(formattedDate);
    }
    
    const shoppingFor = $("input[name='shopping_for']:checked").val();
    if (shoppingFor) {
      $('#shopping_for_hidden').val(shoppingFor);
    }
  };

  $('#submitBtnCustom').click(function (e) { // Add the event parameter here
    e.preventDefault();
    const values = getValues();
    const errors = validate(values);
    renderErrors(errors);
    if (Object.keys(errors).length === 0) {
      console.log("No validation errors, submitting form");
      passValuesToHiddenInputs();
      
      const $form = $('#email_signup');
      const ajaxUrl = $form.attr('data-ajax-submit');
      
      $.ajax({
        type: 'POST',
        url: ajaxUrl,
        data: $form.serialize(),
        success: function(response) {
          $('.hide_on_submit').hide();
          $('.klaviyo_form_actions').hide();
          $('.klaviyo_submit').hide();
          $('.newsletter-subs__form').css('bottom', '170px');
          $('.success_message').show();
        },
        error: function(xhr, status, error) {
          $('.error_message').html("There was an error submitting your form. Please try again.").show();
        }
      });
    } else {
      console.log("Validation failed, preventing submission");
    }
  });

  $('.birthday-input input').on('focus change input', function() {
    const hasValue = $('#birthdayMonth').val() || $('#birthdayDay').val() || $('#birthdayYear').val();
    
    if (hasValue) {
      $('.birthday-input').addClass('has-value');
    } else {
      $('.birthday-input').removeClass('has-value');
    }
  });

  $(document).ready(function() {
    const hasValue = $('#birthdayMonth').val() || $('#birthdayDay').val() || $('#birthdayYear').val();
    
    if (hasValue) {
      $('.birthday-input').addClass('has-value');
    }
  });

  $(document).ready(function() {
    // Add input validation and formatting for month field
    $('#birthdayMonth').on('input', function() {
      const val = $(this).val();
      if (val.length >= 2) {
        $('#birthdayDay').focus();
      }
      if (parseInt(val) > 12) {
        $(this).val(12);
      }
    });
    
    // Add input validation and formatting for day field
    $('#birthdayDay').on('input', function() {
      const val = $(this).val();
      if (val.length >= 2) {
        $('#birthdayYear').focus();
      }
      if (parseInt(val) > 31) {
        $(this).val(31);
      }
    });
    
    // Add input validation and formatting for year field
    $('#birthdayYear').on('input', function() {
      const val = $(this).val();
      const currentYear = new Date().getFullYear();
      if (val.length > 4) {
        $(this).val(val.substring(0, 4));
      }
      if (parseInt(val) > currentYear) {
        $(this).val(currentYear);
      }
    });
    
    $('#birthdayMonth, #birthdayDay, #birthdayYear').on('input change focus', function() {
      const hasValue = $('#birthdayMonth').val() || $('#birthdayDay').val() || $('#birthdayYear').val();
      
      if (hasValue) {
        $('.birthday-submit-wrapper').addClass('has-value');
        $('.birthday-input').addClass('has-value');
        $('label[for="birthday"]').hide();
        $('.birthday-input').css('display', 'flex');
      }
    });
    
    const hasValue = $('#birthdayMonth').val() || $('#birthdayDay').val() || $('#birthdayYear').val();
    
    if (hasValue) {
      $('.birthday-submit-wrapper').addClass('has-value');
      $('.birthday-input').addClass('has-value');
      $('label[for="birthday"]').hide();
      $('.birthday-input').css('display', 'flex');
    }
  });
</script>

{% schema %}
{
"name": "Newsletter Subscription",
"settings": [
{
"type": "text",
"id": "list_id",
"label": "Klaviyo List ID"
},
{
"type": "image_picker",
"id": "bg_image_desktop",
"label": "Background Image (Desktop)"
},
{
"type": "image_picker",
"id": "bg_image_mobile",
"label": "Background Image (Mobile)"
},
{
"type": "textarea",
"id": "heading",
"label": "Heading"
},
{
"type": "textarea",
"id": "subheading",
"label": "Subheading"
},
{
"type": "text",
"id": "success_message_heading",
"label": "Success message heading"
},
{
"type": "text",
"id": "success_message_subheading",
"label": "Success message subheading"
},
{
"type": "text",
"id": "success_message_btn_text",
"label": "Success message button text"
},
{
"type": "url",
"id": "success_message_btn_link",
"label": "Success message button link"
}
]
}
{% endschema %}